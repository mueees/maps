var passport = require('passport')
    , async = require('async')
    , HttpError = require('error').HttpError
    , MemberModel = require('member/model/member')
    , LocalStrategy = require('passport-local').Strategy
    //, BasicStrategy = require('passport-http').BasicStrategy
    , logger = require('libs/log')(module)
    , config = require("config");

passport.serializeUser(function(id, done) {
    done(null, id);
});

passport.deserializeUser(function(id, done) {
    MemberModel.findById(id, function(err, member){
        done(err, member);
    })
});

/**
 * LocalStrategy
 *
 * This strategy is used to authenticate users based on a username and password.
 * Anytime a request is made to authorize an application, we must ensure that
 * a user is logged in before asking them to approve the request.
 */

passport.use(new LocalStrategy(
    { usernameField: 'email'},
    function(email, password, done) {
        async.waterfall([
            function(cb){
                MemberModel.isHaveMember(email, cb);
            }, function(member, cb){
                if( !member ){ return cb('Unknown email address')}
                if(!MemberModel.comparePassword(password, member.password)){
                    return cb('Invalid Password');
                }
                switch(member.status){
                    case 200:
                        return cb(null, member);
                        break;
                    case 400:
                        return cb("User not confirmed. Please check email");
                        break;
                }

            }
        ], function(err, member){
            if(err) return done(new HttpError(401, err));
            return done(null, member._id);
        })

    }
));